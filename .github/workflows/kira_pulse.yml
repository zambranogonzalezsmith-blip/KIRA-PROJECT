import yfinance as yf
import firebase_admin
from firebase_admin import credentials, db
import os
import json

# 1. Configuraci√≥n de Seguridad
firebase_config_raw = os.getenv('FIREBASE_CONFIG')
if not firebase_config_raw:
    raise ValueError("‚ùå Error: La variable FIREBASE_CONFIG no est√° configurada en los Secrets.")

cred_dict = json.loads(firebase_config_raw)
if not firebase_admin._apps:
    cred = credentials.Certificate(cred_dict)
    firebase_admin.initialize_app(cred, {
        'databaseURL': 'https://kira-projet-default-rtdb.firebaseio.com'
    })

def analizar_mercado():
    print("üì° Kira iniciando an√°lisis de EUR/USD...")
    
    # 2. Obtener datos de Yahoo Finance
    ticker = yf.Ticker("EURUSD=X")
    data = ticker.history(period="1d", interval="15m")
    
    if data.empty:
        print("‚ùå No se pudieron obtener datos del mercado.")
        return

    precio_actual = data['Close'].iloc[-1]
    
    # L√≥gica simple de FVG / Tendencia (SMC)
    # Aqu√≠ puedes expandir tu l√≥gica seg√∫n el archivo.json
    tendencia = "BULLISH" if precio_actual > data['Open'].iloc[-1] else "BEARISH"
    fvg_status = "Oportunidad de COMPRA" if tendencia == "BULLISH" else "Oportunidad de VENTA"

    # 3. CONEXI√ìN EXACTA CON TU HTML
    # Tu HTML busca en 'trading/EURUSD', as√≠ que aqu√≠ usamos la misma ruta
    ref = db.reference('trading/EURUSD')
    
    payload = {
        'precio': round(precio_actual, 5),
        'fvg': fvg_status,
        'tendencia': tendencia,
        'last_update': str(data.index[-1])
    }

    ref.set(payload)
    print(f"‚úÖ Kira envi√≥ con √©xito: {payload['precio']} ({tendencia})")

if __name__ == "__main__":
    analizar_mercado()
