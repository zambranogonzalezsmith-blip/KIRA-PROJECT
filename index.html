<script>
    // --- 1. CONFIGURACIÓN FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBu6ChPonWQSKoTnXDaxdgGr4UKzZUiTHg",
        authDomain: "kira-projet.firebaseapp.com",
        databaseURL: "https://kira-projet-default-rtdb.firebaseio.com", 
        projectId: "kira-projet",
        storageBucket: "kira-projet.firebasestorage.app",
        messagingSenderId: "666447987197",
        appId: "1:666447987197:web:2f9de6a52c32766c495994",
        measurementId: "G-TEPVXE5NJN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. CONFIGURACIÓN GRÁFICO ---
    const chartContainer = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartContainer, {
        layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#6b7280' },
        grid: { vertLines: { color: '#111827' }, horzLines: { color: '#111827' } },
        rightPriceScale: { borderColor: '#1f2937', autoScale: true },
        timeScale: { borderColor: '#1f2937', timeVisible: true },
    });

    const candleSeries = chart.addCandlestickSeries({
        upColor: '#10b981', downColor: '#ef4444',
        borderUpColor: '#10b981', borderDownColor: '#ef4444',
        wickUpColor: '#10b981', wickDownColor: '#ef4444',
    });

    // --- 3. LÓGICA DE DIBUJADO DE ZONAS (FVG) ---
    let currentFvgLines = []; // Array para limpiar dibujos previos

    function dibujarZonasSMC(data) {
        // Limpiamos líneas anteriores para no saturar
        currentFvgLines.forEach(line => candleSeries.removePriceLine(line));
        currentFvgLines = [];

        if (data.fvg && (data.fvg.includes("ACTIVA") || data.fvg.includes("DETECTADO"))) {
            const esCompra = data.fvg.includes("COMPRA");
            const color = esCompra ? '#10b981' : '#ef4444';
            const precioBase = parseFloat(data.precio);

            // Creamos dos líneas que delimitan el "Gap" (Simulado por ahora)
            // En una actualización futura del data_bridge, usaremos top/bottom reales
            const lineTop = candleSeries.createPriceLine({
                price: precioBase + 0.00010,
                color: color,
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                axisLabelVisible: true,
                title: esCompra ? 'FVG SUPPORT' : 'FVG RESISTANCE',
            });

            const lineBottom = candleSeries.createPriceLine({
                price: precioBase - 0.00010,
                color: color,
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                axisLabelVisible: false,
            });

            currentFvgLines.push(lineTop, lineBottom);
        }
    }

    // --- 4. ESCUCHA DE DATOS Y REACTIVIDAD ---
    let lastCandle = null;

    function updateKiraVisuals(fvgStatus) {
        const avatar = document.getElementById('kira-avatar');
        const card = document.getElementById('signal-card');
        if (fvgStatus.includes("ACTIVA") || fvgStatus.includes("DETECTADO")) {
            avatar.classList.add('kira-active');
            card.classList.add('pulse-active');
            avatar.style.filter = fvgStatus.includes("COMPRA") ? 
                "drop-shadow(0 0 50px rgba(16, 185, 129, 0.6)) brightness(1.2)" : 
                "drop-shadow(0 0 50px rgba(239, 68, 68, 0.6)) brightness(1.2)";
        } else {
            avatar.classList.remove('kira-active');
            card.classList.remove('pulse-active');
            avatar.style.filter = "drop-shadow(0 0 15px rgba(59, 130, 246, 0.3))";
        }
    }

    function iniciarEscucha() {
        const databaseRef = db.ref('trading/EURUSD'); 
        const statusDot = document.getElementById('connection-status');

        databaseRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            statusDot.classList.replace('bg-red-500', 'bg-green-500');

            const precioActual = parseFloat(data.precio);
            document.getElementById('price-display').innerText = precioActual.toFixed(5);
            document.getElementById('last-ts').innerText = new Date().toLocaleTimeString();
            document.getElementById('display-riesgo').innerText = data.riesgo || "AGRESIVO";
            document.getElementById('display-estrategia').innerText = data.metodo || "SMC / FVG";

            updateKiraVisuals(data.fvg);
            dibujarZonasSMC(data); // <--- Dibuja las líneas en el gráfico

            let colorClass = data.fvg.includes("COMPRA") ? "border-green-500 text-green-400" : 
                            (data.fvg.includes("VENTA") ? "border-red-500 text-red-400" : "border-blue-500 text-blue-400");

            document.getElementById('signals-container').innerHTML = `
                <div class="p-3 border-l-4 ${colorClass} bg-gray-800/40 rounded-r shadow-lg">
                    <div class="text-[9px] text-gray-500 uppercase font-black tracking-widest">Oracle Logic</div>
                    <div class="font-bold text-sm my-1">${data.fvg}</div>
                    <div class="text-[10px] text-gray-400 font-mono">Bias: ${data.tendencia}</div>
                </div>
            `;

            if (!lastCandle) {
                let time = Math.floor(Date.now() / 1000) - (100 * 60);
                const baseData = Array.from({length: 50}, (_, i) => ({
                    time: time + (i * 60),
                    open: precioActual, high: precioActual + 0.0002, low: precioActual - 0.0002, close: precioActual
                }));
                candleSeries.setData(baseData);
                lastCandle = baseData[baseData.length-1];
            } else {
                lastCandle.close = precioActual;
                if (precioActual > lastCandle.high) lastCandle.high = precioActual;
                if (precioActual < lastCandle.low) lastCandle.low = precioActual;
                candleSeries.update(lastCandle);
            }
        });
    }

    iniciarEscucha();

    new ResizeObserver(entries => {
        chart.applyOptions({ width: entries[0].contentRect.width, height: entries[0].contentRect.height });
    }).observe(chartContainer);
</script>
